<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/persian-date/dist/persian-date.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <title>مدیریت کارهای روزمره</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /*
      ========================================
      استایل‌های بازنویسی شده برای UI/UX بهتر
      ========================================
    */
    @import url('https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css');

    :root {
      --green-dark: #2e7d32;
      --green: #43a047;
      --green-light: #66bb6a;
      --green-bg: #e8f5e9;
      --green-bg-light: #f1f8e9;
      --gray-light: #f7f9fc;
      --gray-border: #e0e0e0;
      --text-dark: #333;
      --text-light: #6c757d;
      --danger: #e53935;
      --danger-hover: #c62828;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 25px rgba(46, 125, 50, 0.15);
    }

    html {
      font-size: clamp(14px, 1.5vw + 8px, 17px);
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Vazir', sans-serif;
      direction: rtl;
      margin: 0;
      padding: 0;
      background: linear-gradient(175deg, #ffffff 0%, var(--gray-light) 100%);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      font-size: clamp(0.9rem, 2vw, 1rem);
      color: var(--text-dark);
      overflow-x: hidden;
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 clamp(1rem, 5vw, 2rem);
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }

    h1 {
      text-align: center;
      color: var(--green-dark);
      margin: 1.5rem 0;
      font-weight: 900;
      font-size: clamp(1.75rem, 4vw, 2.25rem);
    }

    #start-tour-btn {
      background: var(--green-bg);
      color: var(--green-dark);
      border: 1px solid var(--green-light);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    #start-tour-btn:hover {
      background: var(--green);
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .container {
      flex-grow: 1;
      padding: 0 clamp(1rem, 5vw, 2rem) 8rem;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }

    .tasks-section {
      display: none;
      flex-direction: column;
    }
    .tasks-section.active {
      display: flex;
    }

    /* --- کارت‌های وظیفه (Flexbox) --- */
    .task {
      background: white;
      border-radius: 1rem;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      border: 1px solid var(--gray-border);
      margin-bottom: 1.25rem;
    }
    .task:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
      border-color: var(--green-light);
    }
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      cursor: pointer;
      gap: 1rem;
    }
    .task-header .task-main-title {
      font-size: clamp(1rem, 2.2vw, 1.15rem);
      color: var(--green-dark);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex-grow: 1;
      min-width: 0;
    }
    .toggle-icon {
      color: var(--green);
      transition: transform 0.3s ease;
      font-size: 0.9rem;
    }
    .task.expanded .toggle-icon {
      transform: rotate(180deg);
    }
    .task-details {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height 0.5s ease-out, opacity 0.3s ease-in;
      display: flex;
      flex-direction: column; 
    }
    .task.expanded .task-details {
      max-height: 1500px;
      opacity: 1;
    }
    .task-details-main-content {
      padding: 1.25rem;
      border-top: 1px solid var(--gray-border);
      flex-grow: 1;
      overflow-y: auto;
    }
    .task-details-main-content p {
      margin: 0 0 1rem;
      font-size: clamp(0.9rem, 1.8vw, 1rem);
      color: var(--text-dark);
    }
    .actions-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1.25rem;
      border-top: 1px solid var(--gray-border);
      background-color: white;
      flex-direction: row-reverse;
      flex-shrink: 0;
    }
    .action-buttons {
      display: flex;
      gap: 0.25rem;
    }
    .task-date-footer {
      font-size: 0.8rem;
      color: var(--text-light);
    }
    .action-btn {
      border: none;
      color: var(--text-light);
      font-size: 1.1rem;
      padding: 0.5rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .action-btn:hover {
      background-color: var(--gray-light);
    }
    .action-btn.archive:hover, .action-btn.restore:hover {
      color: var(--green-dark);
    }
    .action-btn.delete:hover {
      color: var(--danger);
    }
    
    /* --- مراحل وظیفه --- */
    .workflow-list {
      padding-inline-start: 1.5rem;
      color: var(--text-light);
      font-size: 0.9rem;
      margin-bottom: 1.25rem;
    }
    .workflow-step {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 0.25rem;
      border-radius: 6px;
      transition: background-color 0.2s;
    }
    .workflow-step:hover {
      background-color: var(--gray-light);
    }
    .drag-handle {
      cursor: grab;
      color: #b0bec5;
    }
    .drag-handle:active {
      cursor: grabbing;
    }
    .workflow-step .checkbox {
      width: 18px;
      height: 18px;
      min-width: 18px;
      border: 2px solid var(--green-light);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s, border-color 0.2s;
    }
    .workflow-step .checkbox i {
      color: white;
      font-size: 12px;
      transform: scale(0);
      transition: transform 0.2s ease;
    }
    .workflow-step.completed .checkbox {
      background-color: var(--green);
      border-color: var(--green);
    }
    .workflow-step.completed .checkbox i {
      transform: scale(1);
    }
    .workflow-step.completed .step-title {
      text-decoration: line-through;
      color: var(--text-light);
    }
    .step-main {
      display: flex;
      align-items: center;
      flex-grow: 1;
      overflow: hidden; 
    }
    .step-title {
      color: var(--text-dark);
      cursor: pointer;
      display: -webkit-box;
      -webkit-line-clamp: 1; /* <<-- پیش‌فرض تک خطی */
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      word-break: break-word;
      transition: -webkit-line-clamp 0.3s ease-in-out;
    }
    .step-title.expanded {
      -webkit-line-clamp: 100; /* <<-- در حالت باز شده چند خطی می‌شود */
    }
    .step-actions {
      display: flex;
    }
    .step-actions button {
      background: none;
      border: none;
      color: var(--text-light);
      cursor: pointer;
      padding: 0.25rem 0.5rem;
    }
    .step-actions button:hover {
      color: var(--green-dark);
    }
    .step-actions .delete-step-btn:hover {
      color: var(--danger);
    }
    
    .add-step-container {
      display: flex;
      gap: 0.5rem;
      width: 100%;
      margin-bottom: 1rem;
    }
    .new-step-input {
      flex-grow: 1;
      padding: 0.5rem 0.75rem;
      border: 1.5px solid var(--gray-border);
      border-radius: 0.5rem;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s;
    }
    .new-step-input:focus {
      border-color: var(--green);
    }
    button.add-step-btn {
      font-family: 'Vazir', sans-serif; border: none; border-radius: 0.5rem; padding: 0.6rem 1.2rem;
      font-size: 0.9rem; font-weight: 700; cursor: pointer; transition: all 0.25s ease;
      background: var(--green); color: white;
    }
    button.add-step-btn:hover {
      background: var(--green-dark); transform: translateY(-2px);
    }
    
    /* --- حالت ویرایش --- */
    .edit-main-title-input, .workflow-step .edit-input {
      display: none;
    }
    .task.edit-mode .task-main-title, .workflow-step.editing .step-main {
      display: none;
    }
    .task.edit-mode .edit-main-title-input, .workflow-step.editing .edit-input {
      display: block;
    }
    .edit-main-title-input {
      width: 100%;
      font-size: clamp(1rem, 2.2vw, 1.15rem);
      font-weight: 700;
      color: var(--green-dark);
      border: 2px solid var(--green);
      border-radius: 8px;
      padding: 0.25rem 0.5rem;
      font-family: 'Vazir', sans-serif;
      outline: none;
    }
    .workflow-step .edit-input {
      flex-grow: 1;
      padding: 0.25rem 0.5rem;
      font-size: 0.9rem;
      border: 1px solid var(--green);
      border-radius: 4px;
    }
    .task.edit-mode .task-header {
      cursor: default;
    }
    .workflow-step .delete-step-btn {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .task.edit-mode .delete-step-btn {
      opacity: 1;
      pointer-events: auto;
    }
    .task.edit-mode .step-title {
      cursor: text;
      background-color: var(--green-bg-light);
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
    }
    .task.edit-mode .action-btn.edit-task i::before {
      content: "\f00c";
      font-weight: 900;
    }
    
    /* --- تب‌های پایین --- */
    .bottom-tabs {
      position: fixed; bottom: 0; left: 0; right: 0; background: white;
      box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.05); display: flex;
      justify-content: center; gap: 1rem; padding: 0.75rem 0; z-index: 1000;
      border-top: 1px solid var(--gray-border);
    }
    .tab-btn {
      background: transparent; border: none; font-family: 'Vazir';
      font-weight: 700; font-size: 0.95rem; padding: 0.6rem 1.5rem;
      border-radius: 2rem; cursor: pointer; color: var(--text-light);
      transition: all 0.3s ease; display: flex; align-items: center; gap: 0.6rem;
    }
    .tab-btn.active, .tab-btn:hover {
      background-color: var(--green-dark); color: white; box-shadow: var(--shadow-lg);
      transform: translateY(-3px);
    }
    
    /* --- سایر استایل‌ها --- */
    .empty-msg { text-align: center; font-style: italic; color: var(--text-light); margin-top: 2rem; background: var(--green-bg-light); padding: 2rem; border-radius: 1rem; border: 2px dashed var(--green-light); }
    .custom-floating-form__fab { position: fixed; bottom: 6.5rem; right: 1.5rem; width: clamp(55px, 12vw, 65px); height: clamp(55px, 12vw, 65px); font-size: clamp(1.8rem, 5vw, 2.2rem); border-radius: 50%; background-color: var(--green-dark); color: white; border: none; cursor: pointer; box-shadow: var(--shadow-md); display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; z-index: 1100; }
    .custom-floating-form__fab:hover { background-color: var(--green); transform: scale(1.1) rotate(15deg); }
    .custom-floating-form__overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); z-index: 1200; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .custom-floating-form__overlay.active { opacity: 1; pointer-events: auto; }
    .custom-floating-form { position: fixed; top: 50%; left: 50%; width: 60px; height: 60px; background-color: white; border-radius: 50%; box-shadow: var(--shadow-lg); overflow: hidden; z-index: 1300; display: none; align-items: center; justify-content: center; transform: translate(-50%, -50%); }
    .custom-floating-form__form { width: 100%; padding: 2rem 1.5rem; box-sizing: border-box; display: flex; flex-direction: column; gap: 1rem; opacity: 0; }
    .custom-floating-form__form.active { opacity: 1; transition: opacity 0.3s ease 0.2s; }
    .custom-floating-form__title { margin: 0 0 0.5rem; color: var(--green-dark); font-size: 1.5rem; text-align: center; font-weight: 800; }
    .custom-floating-form__input { padding: 0.8rem 1rem; border: 1.5px solid var(--gray-border); border-radius: 0.75rem; font-size: 1rem; outline: none; transition: all 0.2s ease; }
    .custom-floating-form__input:focus { border-color: var(--green); box-shadow: 0 0 0 3px var(--green-bg); }
    .custom-floating-form__submit { background-color: var(--green); color: white; border: none; border-radius: 0.75rem; padding: 0.8rem 1rem; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.3s; }
    .custom-floating-form__submit:hover { background-color: var(--green-dark); transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .custom-floating-form__close-btn { position: absolute; top: 10px; left: 10px; background: transparent; border: none; font-size: 1.5rem; color: var(--text-light); cursor: pointer; width: 30px; height: 30px; line-height: 30px; text-align: center; }
    .tour-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(3px); z-index: 9998; }
    .tour-highlight-box { position: fixed; border: 3px solid var(--green); border-radius: 12px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); z-index: 9999; transition: all 0.4s ease-in-out; }
    .tour-tooltip { position: fixed; background: white; color: var(--text-dark); padding: 1rem 1.25rem; border-radius: 0.75rem; max-width: 320px; font-size: 0.95rem; z-index: 10001; box-shadow: var(--shadow-lg); border-top: 4px solid var(--green); transition: all 0.4s ease-in-out; font-family: 'Vazir', sans-serif; }
    .tour-tooltip::before { content: ''; position: absolute; left: 20px; border: 8px solid transparent; }
    .tour-tooltip.pos-bottom::before { top: -16px; border-bottom-color: var(--green); }
    .tour-tooltip.pos-top::before { bottom: -16px; border-top-color: var(--green); }
    .tour-next-btn { margin-top: 1rem; background: var(--green); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 0.5rem; cursor: pointer; font-weight: bold; }
    .tour-next-btn:hover { background: var(--green-dark); }

    /* --- انیمیشن‌ها --- */
    @keyframes dropIn {
      from { opacity: 0; transform: translateY(-50px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .task.newly-created {
      animation: dropIn 0.5s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
    }
    @keyframes fadeInDown {
      from { opacity: 0; transform: translate3d(0, -20px, 0); }
      to { opacity: 1; transform: translate3d(0, 0, 0); }
    }
    .workflow-step.newly-added {
      animation: fadeInDown 0.4s ease-out;
    }
    @keyframes slideFadeOutLeft {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(-30px); max-height: 0; padding: 0; margin: 0; border: 0; }
    }
    .workflow-step.is-deleting {
      animation: slideFadeOutLeft 0.35s ease-in-out forwards;
    }
    @keyframes slideFadeOutDown {
      from { opacity: 1; transform: translateY(0); max-height: 500px; }
      to { opacity: 0; transform: translateY(50px); max-height: 0; padding: 0; margin-bottom: 0; border-width: 0; }
    }
    .task.is-removing {
      animation: slideFadeOutDown 0.4s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
    }

    /* --- Media Queries --- */
    @media (max-width: 500px) {
      .task-header { flex-wrap: wrap; padding-bottom: 0.5rem; }
      .task-header .task-main-title { white-space: nowrap; flex-basis: 100%; order: 1; margin-bottom: 0.5rem; font-size: 1.1rem; }
      .task-header .toggle-icon { order: 2; }
      .task-header .task-date { display: none !important; }
      .task-details .actions-footer { flex-direction: column; align-items: flex-start; gap: 0.5rem; padding: 0.75rem; }
      .task-details .actions-footer .action-buttons { align-self: flex-end; }
    }

  </style>
</head>
<body>

  <!-- المان‌های تور -->
  <div class="tour-overlay" style="display:none;"></div>
  <div class="tour-highlight-box" style="display:none;"></div>
  <div class="tour-tooltip" style="display:none;">
    <div class="tour-tooltip-text"></div>
    <button class="tour-next-btn">بعدی</button>
  </div>

  <div class="header-container">
    <h1>مدیریت کارها</h1>
    <button id="start-tour-btn">شروع راهنما</button>
  </div>

  <!-- دکمه شناور -->
  <button class="custom-floating-form__fab">✏️</button>

  <!-- لایه تیره -->
  <div class="custom-floating-form__overlay"></div>

  <!-- فرم شناور -->
  <div class="custom-floating-form">
    <form id="custom-floating-form__form" class="custom-floating-form__form">
      <button class="custom-floating-form__close-btn" type="button">×</button>
      <h2 class="custom-floating-form__title">افزودن وظیفه جدید</h2>
      <input type="text" name="title" placeholder="عنوان کار" required class="custom-floating-form__input" />
      <input type="text" name="description" placeholder="توضیحات (اختیاری)" class="custom-floating-form__input" />
      <button type="submit" class="custom-floating-form__submit">افزودن</button>
    </form>
  </div>

  <div class="container">
    <section id="active-tasks-section" class="tasks-section active">
      <div id="active-tasks"></div>
      <div id="active-empty" class="empty-msg" style="display:none;">لیست کارهای فعال شما خالی است!</div>
    </section>

    <section id="archived-tasks-section" class="tasks-section">
      <div id="archived-tasks"></div>
      <div id="archived-empty" class="empty-msg" style="display:none;">آرشیو شما خالی است.</div>
    </section>
  </div>

  <div class="bottom-tabs">
    <button class="tab-btn active" data-target="active-tasks-section">
      <i class="fas fa-list-check"></i>
      <span>کارهای فعال</span>
    </button>
    <button class="tab-btn" data-target="archived-tasks-section">
      <i class="fas fa-box-archive"></i>
      <span>بایگانی</span>
    </button>
  </div>

<script>
// ===================================
// شروع منطق اصلی برنامه (نسخه نهایی و اصلاح شده)
// ===================================
const API_URL = 'https://dailytasks.wegom17380.workers.dev/tasks';

// تعریف متغیرهای سراسری برای کانتینرها
const activeContainer = document.getElementById('active-tasks');
const archivedContainer = document.getElementById('archived-tasks');
const activeEmpty = document.getElementById('active-empty');
const archivedEmpty = document.getElementById('archived-empty');
const tabs = document.querySelectorAll('.tab-btn');

// -------------------------------------------------------------------
// بخش ۱: توابع کمکی (Helper Functions)
// -------------------------------------------------------------------

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function removeTaskCard(cardElement) {
    cardElement.classList.add('is-removing');
    cardElement.addEventListener('animationend', () => {
        cardElement.remove();
        checkEmptyStates();
    });
}

function checkEmptyStates() {
    activeEmpty.style.display = activeContainer.children.length === 0 ? 'block' : 'none';
    archivedEmpty.style.display = archivedContainer.children.length === 0 ? 'block' : 'none';
}

function createStepElement(stepData) {
    const li = document.createElement('li');
    li.className = `workflow-step ${stepData.done ? 'completed' : ''}`;
    li.dataset.stepId = stepData.id;
    li.innerHTML = `
      <span class="drag-handle"><i class="fas fa-grip-vertical"></i></span>
      <div class="checkbox" role="checkbox" aria-checked="${stepData.done}"><i class="fas fa-check"></i></div>
      <div class="step-main">
        <span class="step-title">${escapeHtml(stepData.title)}</span>
        <div class="step-actions"><button class="delete-step-btn" title="حذف"><i class="fas fa-trash-alt"></i></button></div>
      </div>
      <input type="text" class="edit-input" value="${escapeHtml(stepData.title)}" />
    `;
    return li;
}

// -------------------------------------------------------------------
// بخش ۲: تابع اصلی ساخت DOM و اتصال رویدادها
// -------------------------------------------------------------------

function addTaskToDOM(task) {
    const div = document.createElement('div');
    div.className = 'task';
    div.dataset.taskId = task.id;
    const isArchived = task.archived;
    const shamsiDate = new persianDate(new Date(task.createdAt)).format('dddd D MMMM YYYY - HH:mm');

    div.innerHTML = `
      <div class="task-header">
        <span class="toggle-icon fas fa-chevron-down"></span>
        <strong class="task-main-title" title="${escapeHtml(task.title)}">${escapeHtml(task.title)}</strong>
        <input type="text" class="edit-main-title-input" value="${escapeHtml(task.title)}" />
      </div>
      <div class="task-details">
          <div class="task-details-main-content">
              <p>${escapeHtml(task.description) || '<i>بدون توضیحات</i>'}</p>
              <ul class="workflow-list"></ul>
              ${!isArchived ? `
              <div class="add-step-container">
                  <input type="text" class="new-step-input" placeholder="نام مرحله جدید...">
                  <button class="add-step-btn">افزودن</button>
              </div>` : ''}
          </div>
          <div class="actions-footer">
              <div class="action-buttons">
              ${!isArchived ? `<button class="action-btn edit-task" title="ویرایش وظیفه"><i class="fas fa-pencil-alt"></i></button> <button class="action-btn archive" title="بایگانی"><i class="fas fa-archive"></i></button> <button class="action-btn delete" title="حذف"><i class="fas fa-trash-alt"></i></button>` : `<button class="action-btn restore" title="بازیابی"><i class="fas fa-undo-alt"></i></button> <button class="action-btn delete" title="حذف کامل"><i class="fas fa-trash-alt"></i></button>`}
              </div>
              <span class="task-date-footer">${shamsiDate}</span>
          </div>
      </div>
    `;

    const workflowList = div.querySelector('.workflow-list');
    (task.workflow || []).forEach(stepData => {
        const stepElement = createStepElement(stepData);
        workflowList.appendChild(stepElement);
    });

    return div;
}

// <<<<<<<<<<<<<<<< این تابع را به طور کامل جایگزین کنید >>>>>>>>>>>>>>>>
function initializeTaskInteractions(taskCard, taskData) {
    const isArchived = taskData.archived;
    const workflowList = taskCard.querySelector('.workflow-list');

    // --- رویدادهای عمومی کارت ---
    taskCard.querySelector('.task-header').addEventListener('click', (e) => {
        // جلوگیری از باز/بسته شدن هنگام کلیک روی اینپوت ویرایش
        if (!e.target.closest('.edit-main-title-input')) {
            taskCard.classList.toggle('expanded');
        }
    });

    taskCard.querySelector('.actions-footer .delete').onclick = async () => {
        if (!confirm('آیا برای حذف این وظیفه مطمئن هستید؟')) return;
        removeTaskCard(taskCard);
        try {
            await fetch(`${API_URL}/${taskData.id}`, { method: 'DELETE' });
        } catch (err) {
            alert("خطا در حذف وظیفه."); fetchAndRender();
        }
    };

    // --- اتصال رویدادها به هر مرحله (Step) ---
    taskCard.querySelectorAll('.workflow-step').forEach(stepElement => {
        initializeStepInteractions(stepElement, taskData, taskCard);
    });
    
    // --- رویدادهای مختص تسک‌های فعال ---
    if (!isArchived) {
        // فعال کردن قابلیت کشیدن و رها کردن (Drag & Drop)
        new Sortable(workflowList, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'step-ghost',
            onEnd: async (evt) => {
                const newOrderIds = Array.from(evt.target.children).map(li => li.dataset.stepId);
                try {
                    await fetch(`${API_URL}/${taskData.id}/workflow/reorder`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order: newOrderIds }),
                    });
                    // نیازی به fetchAndRender نیست چون ترتیب در DOM درست است
                } catch (err) {
                    alert('خطا در ذخیره ترتیب جدید. لطفا صفحه را رفرش کنید.');
                    fetchAndRender(); // در صورت خطا، بازسازی می‌کنیم
                }
            },
        });

        // بایگانی
        taskCard.querySelector('.actions-footer .archive').onclick = async () => {
            removeTaskCard(taskCard);
            try {
                await fetch(`${API_URL}/${taskData.id}/archive`, { method: 'POST' });
                fetchAndRender('archived');
            } catch (err) {
                alert("خطا در بایگانی."); fetchAndRender();
            }
        };

        // افزودن مرحله
        // <<<<<<<<<<<<<<<< این رویداد را به طور کامل جایگزین کنید >>>>>>>>>>>>>>>>
        // افزودن مرحله (نسخه نهایی و خوش‌بینانه)
        const addStepBtn = taskCard.querySelector('.add-step-btn');
        const newStepInput = taskCard.querySelector('.new-step-input');
        addStepBtn.onclick = async () => {
            const stepName = newStepInput.value.trim();
            if (!stepName) return alert('نام مرحله نمی‌تواند خالی باشد.');

            const tempId = `temp-${Date.now()}`; // یک آیدی موقت برای المان DOM
            const newStepData = {
                id: tempId,
                title: stepName,
                done: false
            };
            
            // ۱. آپدیت خوش‌بینانه: بلافاصله المان را بساز و به DOM اضافه کن
            const newStepElement = createStepElement(newStepData);
            newStepElement.classList.add('newly-added');
            workflowList.appendChild(newStepElement);
            
            // به صورت موقت، رویدادها را به این المان اضافه می‌کنیم (به جز حذف و ویرایش)
            newStepElement.querySelector('.checkbox').onclick = () => {
                alert("لطفاً صبر کنید تا مرحله ذخیره شود.");
                return false; // جلوی تیک زدن را می‌گیرد
            };
            
            const originalInputValue = newStepInput.value;
            newStepInput.value = '';
            newStepInput.focus();
            addStepBtn.disabled = true;

            try {
                // ۲. ارسال درخواست به سرور در پس‌زمینه
                const response = await fetch(`${API_URL}/${taskData.id}/workflow`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ step: stepName }) });
                
                if (!response.ok) throw new Error('Failed to add step');
                
                const updatedTask = await response.json();
                const newlySavedStep = updatedTask.workflow.find(s => s.title === stepName && !taskData.workflow.some(ts => ts.id === s.id));
                
                if (newlySavedStep) {
                    // ۳. آپدیت المان موقت با ID واقعی از سرور
                    const tempElement = workflowList.querySelector(`[data-step-id="${tempId}"]`);
                    if (tempElement) {
                        tempElement.dataset.stepId = newlySavedStep.id; // آیدی واقعی را جایگزین کن
                        // حالا رویدادهای کامل را به آن متصل می‌کنیم
                        initializeStepInteractions(tempElement, updatedTask, taskCard);
                    }
                }
                // داده‌های محلی را هم آپدیت می‌کنیم
                taskData.workflow = updatedTask.workflow;

            } catch (err) {
                alert("خطا در افزودن مرحله: " + err.message);
                // در صورت خطا، المان موقتی که اضافه کردیم را حذف می‌کنیم
                const tempElement = workflowList.querySelector(`[data-step-id="${tempId}"]`);
                if (tempElement) tempElement.remove();
                newStepInput.value = originalInputValue; // مقدار قبلی را برمی‌گردانیم
            } finally {
                addStepBtn.disabled = false;
            }
        };

        // منطق حالت ویرایش (کامل و بدون تغییر)
        const editTaskBtn = taskCard.querySelector('.action-btn.edit-task');
        const mainTitleSpan = taskCard.querySelector('.task-main-title');
        const mainTitleInput = taskCard.querySelector('.edit-main-title-input');
        let originalMainTitleValue = '';
        editTaskBtn.addEventListener('click', () => {
            const isInEditMode = taskCard.classList.contains('edit-mode');
            if (isInEditMode) {
                taskCard.classList.remove('edit-mode');
                mainTitleInput.value = originalMainTitleValue;
            } else {
                originalMainTitleValue = mainTitleSpan.textContent.trim();
                mainTitleInput.value = originalMainTitleValue;
                taskCard.classList.add('edit-mode');
            }
        });
        const saveMainTitle = async () => {
            const newTitle = mainTitleInput.value.trim();
            if (newTitle && newTitle !== originalMainTitleValue) {
                try {
                    await fetch(`${API_URL}/${taskData.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: newTitle }) });
                    mainTitleSpan.textContent = newTitle;
                    mainTitleSpan.title = newTitle;
                    originalMainTitleValue = newTitle;
                } catch (err) { alert('خطا در ذخیره عنوان: ' + err.message); mainTitleInput.value = originalMainTitleValue; }
            } else { mainTitleInput.value = originalMainTitleValue; }
        };
        mainTitleInput.addEventListener('blur', saveMainTitle);
        mainTitleInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); mainTitleInput.blur(); } if (e.key === 'Escape') { mainTitleInput.value = originalMainTitleValue; mainTitleInput.blur(); }});


    } else { // --- رویدادهای مختص تسک‌های بایگانی شده ---
        taskCard.querySelector('.actions-footer .restore').onclick = async () => {
            removeTaskCard(taskCard);
            try {
                await fetch(`${API_URL}/${taskData.id}/restore`, { method: 'POST' });
                fetchAndRender('active');
            } catch (err) {
                alert("خطا در بازیابی."); fetchAndRender();
            }
        };
    }
}




function initializeStepInteractions(stepElement, taskData, taskCard) {
    const stepId = stepElement.dataset.stepId;
    
    // Expand/Collapse
    const titleSpan = stepElement.querySelector('.step-title');
    const isClamped = titleSpan.offsetHeight < titleSpan.scrollHeight;
    if (isClamped) {
        titleSpan.addEventListener('click', (e) => {
            if (!taskCard.classList.contains('edit-mode')) {
                titleSpan.classList.toggle('expanded');
            }
        });
    } else {
        titleSpan.style.cursor = 'default';
    }

    // تیک زدن
    stepElement.querySelector('.checkbox').addEventListener('click', async (e) => {
        const checkbox = e.currentTarget;
        const isCompleted = stepElement.classList.contains('completed');
        const newDoneState = !isCompleted;
        stepElement.classList.toggle('completed', newDoneState);
        checkbox.setAttribute('aria-checked', newDoneState);
        try {
            const response = await fetch(`${API_URL}/${taskData.id}/workflow/${stepId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ done: newDoneState }) });
            if (!response.ok) throw new Error('Server update failed');
        } catch (err) {
            alert("خطا در به‌روزرسانی وضعیت.");
            stepElement.classList.toggle('completed', isCompleted);
            checkbox.setAttribute('aria-checked', isCompleted);
        }
    });

    // حذف مرحله
    stepElement.querySelector('.delete-step-btn').addEventListener('click', async (e) => {
        if (!confirm(`آیا از حذف مرحله "${titleSpan.textContent}" مطمئن هستید؟`)) return;
        stepElement.classList.add('is-deleting');
        stepElement.addEventListener('animationend', () => stepElement.remove());
        try {
            const response = await fetch(`${API_URL}/${taskData.id}/workflow/${stepId}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Server delete failed');
        } catch (err) {
            alert("خطا در حذف مرحله."); fetchAndRender();
        }
    });
    
    // ویرایش مرحله
    const editInput = stepElement.querySelector('.edit-input');
    let originalStepTitle = '';
    titleSpan.addEventListener('click', (e) => {
        if (taskCard.classList.contains('edit-mode')) {
            e.stopPropagation();
            originalStepTitle = titleSpan.textContent.trim();
            stepElement.classList.add('editing');
            editInput.focus();
            editInput.select();
        }
    });
    const saveStepEdit = async () => {
        if (!stepElement.classList.contains('editing')) return;
        const newTitle = editInput.value.trim();
        stepElement.classList.remove('editing');
        if (newTitle && newTitle !== originalStepTitle) {
            try {
                await fetch(`${API_URL}/${taskData.id}/workflow/${stepId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: newTitle }) });
                titleSpan.textContent = newTitle;
            } catch (err) {
                alert(err.message); editInput.value = originalStepTitle;
            }
        } else {
            editInput.value = originalStepTitle;
        }
    };
    editInput.addEventListener('blur', saveStepEdit);
    editInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); saveStepEdit(); } if (e.key === 'Escape') { stepElement.classList.remove('editing'); editInput.value = originalStepTitle; }});
}


// -------------------------------------------------------------------
// بخش ۳: توابع اصلی برنامه
// -------------------------------------------------------------------

function renderTasks(tasks, container) {
    container.innerHTML = '';
    tasks.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    tasks.forEach(taskData => {
        const taskElement = addTaskToDOM(taskData);
        container.appendChild(taskElement);
        initializeTaskInteractions(taskElement, taskData);
    });
}

async function fetchAndRender(only = null) {
    try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error('خطا در دریافت داده‌ها');
        const tasks = await res.json();
        const activeTasks = tasks.filter(t => !t.archived);
        const archivedTasks = tasks.filter(t => t.archived);

        if (only !== 'archived') {
            renderTasks(activeTasks, activeContainer);
        }
        if (only !== 'active') {
            renderTasks(archivedTasks, archivedContainer);
        }
        
        checkEmptyStates();
        handleResponsiveLayout();
    } catch (e) {
        console.error(e);
        alert(e.message);
    }
}

// -------------------------------------------------------------------
// بخش ۴: رویدادهای اولیه و بارگذاری
// -------------------------------------------------------------------

tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const targetId = tab.getAttribute('data-target');
        document.querySelectorAll('.tasks-section').forEach(section => {
            section.classList.toggle('active', section.id === targetId);
        });
    });
});

document.getElementById('custom-floating-form__form').onsubmit = async e => {
    e.preventDefault();
    const form = e.target;
    const title = form.title.value.trim();
    const description = form.description.value.trim();
    if (!title) return alert('عنوان نمی‌تواند خالی باشد.');

    const submitButton = form.querySelector('.custom-floating-form__submit');
    submitButton.disabled = true;
    submitButton.textContent = 'در حال افزودن...';

    // این یک تابع سراسری از اسکریپت انیمیشن فرم است
    if (typeof closeForm === "function") {
        closeForm();
    }
    
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, description, workflow: [] }),
        });
        if (!response.ok) throw new Error('خطا در افزودن وظیفه جدید');
        
        const newTaskData = await response.json();
        const newTaskElement = addTaskToDOM(newTaskData);
        newTaskElement.classList.add('newly-created');
        activeContainer.prepend(newTaskElement);
        checkEmptyStates();
        initializeTaskInteractions(newTaskElement, newTaskData);
        newTaskElement.addEventListener('animationend', () => {
            newTaskElement.classList.remove('newly-created');
        });
    } catch (err) {
        alert(err.message);
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'افزودن';
        form.reset();
    }
};

function handleResponsiveLayout() {
  const screenWidth = window.innerWidth;
  document.querySelectorAll('.task').forEach(task => {
    const header = task.querySelector('.task-header');
    const dateEl = header.querySelector('.task-date');
    if (!dateEl) return;
    if (screenWidth <= 500 && dateEl.parentElement === header) {
      // این بخش دیگر لازم نیست چون تاریخ همیشه در فوتر است
    } 
  });
}

async function initialLoad() {
  await fetchAndRender();
  //handleResponsiveLayout();
  // اضافه کردن رویدادهای تور راهنما
  const tour = new TourGuide();
  const startTourBtn = document.getElementById('start-tour-btn');
  if (startTourBtn) {
    startTourBtn.addEventListener('click', () => tour.start());
  }
  // اضافه کردن رویدادهای مربوط به دکمه شناور
  const fab = document.querySelector(".custom-floating-form__fab");
  if(fab && typeof initializeFab === "function") {
      initializeFab();
  }
}

document.addEventListener('DOMContentLoaded', initialLoad);
window.addEventListener('resize', handleResponsiveLayout);

</script>

  <!-- انیمیشن Anime.js (بدون تغییر) -->
  <script>
    // برای اینکه توابع در دسترس باشند، آنها را در حوزه سراسری قرار می‌دهیم
    let closeForm;

    document.addEventListener("DOMContentLoaded", () => {
      const fab = document.querySelector(".custom-floating-form__fab");
      const wrapper = document.querySelector(".custom-floating-form");
      const form = wrapper.querySelector(".custom-floating-form__form");
      const closeBtn = wrapper.querySelector(".custom-floating-form__close-btn");
      const overlay = document.querySelector(".custom-floating-form__overlay");
      let isOpen = false;

      function openForm() {
        if (isOpen) return;
        isOpen = true;
        overlay.classList.add('active');
        anime({ targets: fab, scale: 0.4, opacity: 0, duration: 250, easing: 'easeOutQuad', complete: () => { fab.style.display = 'none'; } });
        wrapper.style.display = 'flex';
        anime({ targets: wrapper, width: ['60px', '90%'], maxWidth: ['60px', '500px'], height: ['60px', window.innerWidth <= 600 ? '320px' : '280px'], borderRadius: ['50%', '20px'], translateX: ['-50%', '-50%'], translateY: ['-50%', '-50%'], scale: [0.8, 1], easing: 'easeOutElastic(1, .6)', duration: 700, begin: () => { form.classList.add("active"); } });
      }

      closeForm = function() {
        if (!isOpen) return;
        isOpen = false;
        form.classList.remove("active");
        anime({ targets: wrapper, scale: [1, 0.8], opacity: [1, 0], easing: 'easeInBack', duration: 400, complete: () => { wrapper.style.display = 'none'; wrapper.style.opacity = 1; overlay.classList.remove('active'); fab.style.display = 'flex'; anime({ targets: fab, scale: 1, opacity: 1, duration: 350, easing: 'easeOutQuad' }); } });
      }

      fab.addEventListener('click', openForm);
      closeBtn.addEventListener('click', closeForm);
      overlay.addEventListener('click', closeForm);
      form.addEventListener('submit', (e) => {
          // بستن فرم توسط رویداد onsubmit اصلی مدیریت می‌شود
      });
    });
  </script>

  <!-- اسکریپت تور راهنما (بدون تغییر) -->
  <script>
    class TourGuide {
      constructor() {
        this.steps = Array.from(document.querySelectorAll('[data-tour-step]')).sort((a, b) => parseInt(a.dataset.tourStep) - parseInt(b.dataset.tourStep));
        this.currentStep = 0; this.overlay = document.querySelector('.tour-overlay'); this.highlightBox = document.querySelector('.tour-highlight-box');
        this.tooltip = document.querySelector('.tour-tooltip'); this.tooltipText = this.tooltip.querySelector('.tour-tooltip-text'); this.nextBtn = this.tooltip.querySelector('.tour-next-btn');
        if(this.nextBtn) this.nextBtn.addEventListener('click', () => this.nextStep());
      }
      start() { if (this.steps.length === 0) return; this.currentStep = 0; this.overlay.style.display = 'block'; this.showStep(this.currentStep); document.body.style.overflow = 'hidden'; }
      end() { this.overlay.style.display = 'none'; this.highlightBox.style.display = 'none'; this.tooltip.style.display = 'none'; document.body.style.overflow = ''; }
      showStep(index) {
        if (index >= this.steps.length) { return this.end(); }
        const el = this.steps[index];
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => {
          const rect = el.getBoundingClientRect();
          this.highlightBox.style.display = 'block';
          this.highlightBox.style.top = `${rect.top - 5}px`; this.highlightBox.style.left = `${rect.left - 5}px`;
          this.highlightBox.style.width = `${rect.width + 10}px`; this.highlightBox.style.height = `${rect.height + 10}px`;
          this.tooltipText.textContent = el.dataset.tour || '';
          this.tooltip.style.visibility = 'hidden'; this.tooltip.style.display = 'block';
          const tooltipRect = this.tooltip.getBoundingClientRect();
          let tooltipTop = rect.bottom + 15;
          this.tooltip.classList.remove('pos-top', 'pos-bottom');
          if (tooltipTop + tooltipRect.height > window.innerHeight) {
            tooltipTop = rect.top - tooltipRect.height - 15;
            this.tooltip.classList.add('pos-top');
          } else { this.tooltip.classList.add('pos-bottom'); }
          let tooltipLeft = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
          const margin = 10;
          if (tooltipLeft < margin) { tooltipLeft = margin; }
          if (tooltipLeft + tooltipRect.width > window.innerWidth - margin) { tooltipLeft = window.innerWidth - tooltipRect.width - margin; }
          if (tooltipTop < margin) { tooltipTop = margin; }
          if (tooltipTop + tooltipRect.height > window.innerHeight - margin) { tooltipTop = window.innerHeight - tooltipRect.height - margin; }
          this.tooltip.style.top = `${tooltipTop}px`; this.tooltip.style.left = `${tooltipLeft}px`;
          this.tooltip.style.visibility = 'visible';
          this.nextBtn.textContent = (index === this.steps.length - 1) ? 'پایان' : 'بعدی';
        }, 350);
      }
      nextStep() { this.currentStep++; this.showStep(this.currentStep); }
    }
  </script>

</body>
</html>
