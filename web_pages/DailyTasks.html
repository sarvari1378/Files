<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <script src="https://cdn.jsdelivr.net/npm/persian-date/dist/persian-date.min.js"></script>
  <title>مدیریت کارهای روزمره</title>
<style>
  @import url('https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css');

  :root {
    --green-dark: #2e7d32;
    --green: #43a047;
    --green-light: #66bb6a;
    --green-bg: #e8f5e9;
    --gray-light: #f5f5f5;
    --text-light: #4caf50;
  }

  body {
    font-family: 'Vazir', sans-serif;
    direction: rtl;
    margin: 0; padding: 0;
    background: var(--gray-light);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  h1 {
    text-align: center;
    color: var(--green-dark);
    margin: 25px 0;
    font-weight: 900;
  }

  .container {
    flex-grow: 1;
    padding: 0 20px 70px;
    max-width: 900px;
    margin: 0 auto;
  }

  .tasks-section {
    background: white;
    border-radius: 20px;
    box-shadow: 0 8px 30px rgba(46, 125, 50, 0.08);
    padding: 25px;
    display: none;
    flex-direction: column;
  }

  .tasks-section.active {
    display: flex;
  }

  .tasks-section h2 {
    color: var(--green-dark);
    border-bottom: 2px solid var(--green-light);
    padding-bottom: 10px;
    margin-bottom: 25px;
    font-size: 1.4rem;
  }

  .task {
    position: relative;
    background: var(--green-bg);
    border-radius: 16px;
    padding: 18px 22px;
    margin-bottom: 20px;
    box-shadow: 0 4px 14px rgba(46, 125, 50, 0.1);
    transition: all 0.3s ease;
  }

  .task:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(46, 125, 50, 0.25);
  }

  .task strong {
    font-size: 1.2rem;
    color: var(--green-dark);
    margin-bottom: 6px;
    display: block;
  }

  .task p {
    margin: 6px 0 10px;
    font-size: 0.95rem;
    color: #388e3c;
  }

  .workflow-list {
    margin: 0 0 10px;
    padding-inline-start: 18px;
    color: var(--text-light);
    font-size: 0.9rem;
  }

  .task-date {
    position: absolute;
    top: 12px;
    left: 12px;
    background-color: #c8e6c9;
    padding: 4px 10px;
    border-radius: 8px;
    font-size: 0.75rem;
    color: #2e7d32;
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }


  .actions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  button {
    font-family: 'Vazir', sans-serif;
    border: none;
    border-radius: 8px;
    padding: 9px 14px;
    font-size: 0.9rem;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }

  button.delete {
    background: #e53935;
    color: white;
  }

  button.delete:hover {
    background: #c62828;
  }

  button.archive {
    background: #66bb6a;
    color: white;
  }

  button.archive:hover {
    background: #388e3c;
  }

  button.restore {
    background: #43a047;
    color: white;
  }

  button.restore:hover {
    background: #2e7d32;
  }

  button.workflow {
    background: #388e3c;
    color: white;
  }

  button.workflow:hover {
    background: #2e7d32;
  }

  input.new-step-input {
    flex: 1;
    padding: 7px 12px;
    border: 1.5px solid #81c784;
    border-radius: 8px;
    font-size: 0.9rem;
    outline-color: #a5d6a7;
  }

  form#task-form {
    background: white;
    padding: 25px;
    border-radius: 20px;
    box-shadow: 0 6px 20px rgba(46, 125, 50, 0.08);
    margin: 25px auto 10px;
    max-width: 900px;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
  }

  form#task-form input[type="text"] {
    flex: 1 1 200px;
    padding: 10px 15px;
    font-size: 1rem;
    border-radius: 12px;
    border: 1.5px solid #81c784;
    outline-color: #a5d6a7;
  }

  form#task-form button {
    background-color: var(--green-dark);
    color: white;
    padding: 12px 22px;
    border-radius: 12px;
  }

  form#task-form button:hover {
    background-color: #1b5e20;
  }

  .bottom-tabs {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.07);
    display: flex;
    justify-content: center;
    gap: 15px;
    padding: 12px 0;
    z-index: 1000;
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
  }

  .tab-btn {
    background: transparent;
    border: none;
    font-family: 'Vazir', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    padding: 10px 25px;
    border-radius: 30px;
    cursor: pointer;
    color: var(--green-dark);
    transition: 0.3s;
  }

  .tab-btn.active,
  .tab-btn:hover {
    background-color: var(--green-dark);
    color: white;
    box-shadow: 0 4px 12px rgba(56, 142, 60, 0.4);
  }

  .empty-msg {
    text-align: center;
    font-style: italic;
    color: #a5d6a7;
    margin-top: 20px;
  }

  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-thumb {
    background: #b2dfdb;
    border-radius: 8px;
  }

  ::-webkit-scrollbar-track {
    background: #e0f2f1;
    border-radius: 8px;
  }

@media (max-width: 768px) {
  form#task-form {
    display: flex;
    flex-direction: column;  /* فرم به صورت ستون */
    gap: 6px;                /* فاصله خیلی کم بین آیتم‌ها */
    padding: 10px 10px;      /* padding کمی از دو طرف */
  }

  form#task-form input[type="text"],
  form#task-form textarea,
  form#task-form button {
    flex: 1 1;
    width: 100%;             /* تمام عرض */
    padding: 8px 12px;       /* padding مناسب برای ارتفاع کمتر */
    font-size: 1rem;         /* سایز فونت متناسب */
    border-radius: 8px;      /* گوشه‌ها گرد */
    box-sizing: border-box;  /* محاسبه padding در عرض */
  }

  form#task-form button {
    background-color: var(--green-dark);
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }

  form#task-form button:hover {
    background-color: #1b5e20;
  }
}




</style>

</head>
<body>
  <h1>مدیریت کارهای روزمره</h1>

  <form id="task-form">
    <input type="text" id="title" placeholder="عنوان کار" required />
    <input type="text" id="description" placeholder="توضیح (اختیاری)" />
    <button type="submit">➕ افزودن تسک</button>
  </form>

  <div class="container">
    <section id="active-tasks-section" class="tasks-section active">
      <h2>تسک‌های فعال</h2>
      <div id="active-tasks"></div>
      <div id="active-empty" class="empty-msg" style="display:none;">تسکی وجود ندارد</div>
    </section>

    <section id="archived-tasks-section" class="tasks-section">
      <h2>آرشیو تسک‌ها</h2>
      <div id="archived-tasks"></div>
      <div id="archived-empty" class="empty-msg" style="display:none;">آرشیو خالی است</div>
    </section>
  </div>

  <div class="bottom-tabs">
    <button class="tab-btn active" data-target="active-tasks-section">کارهای در حال انجام</button>
    <button class="tab-btn" data-target="archived-tasks-section">آرشیو</button>
  </div>

<script>
  const API_URL = 'https://dailytasks.wegom17380.workers.dev/tasks';

  const activeContainer = document.getElementById('active-tasks');
  const archivedContainer = document.getElementById('archived-tasks');
  const activeEmpty = document.getElementById('active-empty');
  const archivedEmpty = document.getElementById('archived-empty');

  // تب‌ها و سوئیچ
  const tabs = document.querySelectorAll('.tab-btn');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // حذف active از همه تب‌ها
      tabs.forEach(t => t.classList.remove('active'));
      // اضافه کردن به تب کلیک شده
      tab.classList.add('active');
      // نمایش درست بخش
      const targetId = tab.getAttribute('data-target');
      document.querySelectorAll('.tasks-section').forEach(section => {
        if(section.id === targetId) section.classList.add('active');
        else section.classList.remove('active');
      });
    });
  });

  // فرار دادن متن (XSS محافظت)
  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/[&<>"']/g, function(m) {
      switch (m) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return m;
      }
    });
  }

  // دریافت و نمایش تسک‌ها
  async function fetchAndRender() {
    try {
      const res = await fetch(API_URL);
      if (!res.ok) throw new Error('خطا در دریافت داده‌ها');
      const tasks = await res.json();

      const activeTasks = tasks.filter(t => !t.archived);
      const archivedTasks = tasks.filter(t => t.archived);

      renderTasks(activeTasks, activeContainer, false);
      renderTasks(archivedTasks, archivedContainer, true);

      activeEmpty.style.display = activeTasks.length === 0 ? 'block' : 'none';
      archivedEmpty.style.display = archivedTasks.length === 0 ? 'block' : 'none';

    } catch(e) {
      alert(e.message);
    }
  }

  // رندر تسک‌ها داخل کانتینر
  function renderTasks(tasks, container, isArchived) {
    container.innerHTML = '';
    if (tasks.length === 0) return;

    tasks.forEach(task => addTaskToDOM(task, container, isArchived));
  }

  // اضافه کردن کارت تسک به DOM
  function addTaskToDOM(task, container, isArchived) {
    const div = document.createElement('div');
    const shamsiDate = new persianDate(task.createdAt).format('YYYY/MM/DD HH:mm');
    div.className = 'task';

    div.innerHTML = `
      <strong>${escapeHtml(task.title)}</strong>
      <p>${escapeHtml(task.description)}</p>
      <ul class="workflow-list">${(task.workflow || []).map(step => `<li>${escapeHtml(step)}</li>`).join('')}</ul>

      <div class="actions">
        ${
          !isArchived
            ? `
              <div style="display:flex; gap:8px; margin-bottom:8px;">

                <input type="text" class="new-step-input" placeholder="نام مرحله جدید..." style="flex:1; padding:6px; font-size:0.9rem; border-radius:6px; border:1px solid #ccc;" />
                <button class="add-step-btn">➕ مرحله</button>
              </div>
              <button class="archive">آرشیو</button>
              <button class="delete">حذف</button>
              <p class="task-date">${shamsiDate}</p>
            `
            : `
              <button class="restore">بازگردانی</button>
              <button class="delete">حذف</button>
            `
        }
      </div>
    `;

    if (!isArchived) {
      const input = div.querySelector('.new-step-input');
      const addStepBtn = div.querySelector('.add-step-btn');

      addStepBtn.onclick = async () => {
        const stepName = input.value.trim();
        if (!stepName) {
          alert('نام مرحله نمی‌تواند خالی باشد.');
          return;
        }
        try {
          const res = await fetch(`${API_URL}/${task.id}/workflow`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ step: stepName }),
          });
          if (!res.ok) throw new Error('خطا در افزودن مرحله');
          input.value = '';
          await fetchAndRender();
        } catch (err) {
          alert(err.message);
        }
      };

      div.querySelector('.archive').onclick = async () => {
        try {
          const res = await fetch(`${API_URL}/${task.id}/archive`, { method: 'POST' });
          if (!res.ok) throw new Error('خطا در آرشیو کردن');
          await fetchAndRender();
        } catch (err) {
          alert(err.message);
        }
      };

      div.querySelector('.delete').onclick = async () => {
        if (!confirm('آیا مطمئنید می‌خواهید این تسک را حذف کنید؟')) return;
        try {
          const res = await fetch(`${API_URL}/${task.id}`, { method: 'DELETE' });
          if (!res.ok) throw new Error('خطا در حذف تسک');
          await fetchAndRender();
        } catch (err) {
          alert(err.message);
        }
      };

    } else {
      div.querySelector('.restore').onclick = async () => {
        try {
          const res = await fetch(`${API_URL}/${task.id}/restore`, { method: 'POST' });
          if (!res.ok) throw new Error('خطا در بازگردانی تسک');
          await fetchAndRender();
        } catch (err) {
          alert(err.message);
        }
      };

      div.querySelector('.delete').onclick = async () => {
        if (!confirm('آیا مطمئنید می‌خواهید این تسک را حذف کنید؟')) return;
        try {
          const res = await fetch(`${API_URL}/${task.id}`, { method: 'DELETE' });
          if (!res.ok) throw new Error('خطا در حذف تسک');
          await fetchAndRender();
        } catch (err) {
          alert(err.message);
        }
      };
    }

    container.appendChild(div);
  }

  // افزودن تسک جدید
  document.getElementById('task-form').onsubmit = async e => {
    e.preventDefault();
    const title = e.target.title.value.trim();
    const description = e.target.description.value.trim();

    if (!title) {
      alert('عنوان نمی‌تواند خالی باشد.');
      return;
    }

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({title, description, workflow: []}),
      });
      if (!res.ok) throw new Error('خطا در افزودن تسک');
      e.target.reset();
      await fetchAndRender();
    } catch(err) {
      alert(err.message);
    }
  };

  fetchAndRender();
</script>
</body>
</html>
